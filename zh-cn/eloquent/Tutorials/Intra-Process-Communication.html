

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Efficient intra-process communication &mdash; ros2 documentation  文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="canonical" href="https://projects.localizethedocs.org/ros2-docs-l10n/Tutorials/Intra-Process-Communication.html" />
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=946197a6"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=beaddf03"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Recording and playback of topic data with rosbag using the ROS 1 bridge" href="Rosbag-with-ROS1-Bridge.html" />
    <link rel="prev" title="Management of nodes with managed lifecycles" href="Managed-Nodes.html" />
 
<script type="text/javascript" src="../ltd-provenance.js"></script>
<script type="text/javascript" src="../ltd-current.js"></script>
<script type="text/javascript" src="../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../ltd-flyout.js"></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            ros2 documentation
              <img src="../_static/eloquent-small.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Linux-Development-Setup.html">Building ROS 2 on Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Linux-Install-Binary.html">Installing ROS 2 on Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Linux-Install-Debians.html">Installing ROS 2 via Debian Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/macOS-Development-Setup.html">Building ROS 2 on macOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/macOS-Install-Binary.html">Installing ROS 2 on macOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Windows-Development-Setup.html">Building ROS 2 on Windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Windows-Install-Binary.html">Installing ROS 2 on Windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Fedora-Development-Setup.html">Building ROS 2 on Fedora Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Latest-Development-Setup.html">Installing the latest ROS 2 development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Maintaining-a-Source-Checkout.html">Maintaining a source checkout of ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Prerelease-Testing.html">Pre-release Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/DDS-Implementations.html">Installing DDS implementations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Installation/DDS-Implementations/Install-Connext-Security-Plugins.html">Installing Connext security plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Installation/DDS-Implementations/Install-Connext-University-Eval.html">Installing University or Evaluation versions of RTI Connext DDS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Installation/DDS-Implementations/Working-with-Eclipse-CycloneDDS.html">Working with Eclipse Cyclone DDS</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../Tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Configuring-ROS2-Environment.html">Configuring your ROS 2 environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="Turtlesim/Introducing-Turtlesim.html">Introducing turtlesim and rqt</a></li>
<li class="toctree-l2"><a class="reference internal" href="Understanding-ROS2-Nodes.html">Understanding ROS 2 nodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="Topics/Understanding-ROS2-Topics.html">Understanding ROS 2 topics</a></li>
<li class="toctree-l2"><a class="reference internal" href="Services/Understanding-ROS2-Services.html">Understanding ROS 2 services</a></li>
<li class="toctree-l2"><a class="reference internal" href="Parameters/Understanding-ROS2-Parameters.html">Understanding ROS 2 parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="Understanding-ROS2-Actions.html">Understanding ROS 2 actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="Rqt-Console/Using-Rqt-Console.html">Using rqt_console</a></li>
<li class="toctree-l2"><a class="reference internal" href="Launch-Files/Creating-Launch-Files.html">Creating a launch file</a></li>
<li class="toctree-l2"><a class="reference internal" href="Ros2bag/Recording-And-Playing-Back-Data.html">Recording and playing back data</a></li>
<li class="toctree-l2"><a class="reference internal" href="Workspace/Creating-A-Workspace.html">Creating a workspace</a></li>
<li class="toctree-l2"><a class="reference internal" href="Creating-Your-First-ROS2-Package.html">Creating your first ROS 2 package</a></li>
<li class="toctree-l2"><a class="reference internal" href="Writing-A-Simple-Cpp-Publisher-And-Subscriber.html">Writing a simple publisher and subscriber (C++)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Writing-A-Simple-Py-Publisher-And-Subscriber.html">Writing a simple publisher and subscriber (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Writing-A-Simple-Cpp-Service-And-Client.html">Writing a simple service and client (C++)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Writing-A-Simple-Py-Service-And-Client.html">Writing a simple service and client (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Custom-ROS2-Interfaces.html">Creating custom ROS 2 msg and srv files</a></li>
<li class="toctree-l2"><a class="reference internal" href="Single-Package-Define-And-Use-Interface.html">Expanding on ROS 2 interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="Using-Parameters-In-A-Class-CPP.html">Using parameters in a class (C++)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Using-Parameters-In-A-Class-Python.html">Using parameters in a class (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Getting-Started-With-Ros2doctor.html">Getting started with ros2doctor</a></li>
<li class="toctree-l2"><a class="reference internal" href="Actions/Creating-an-Action.html">Creating an action</a></li>
<li class="toctree-l2"><a class="reference internal" href="Actions/Writing-a-Cpp-Action-Server-Client.html">Writing an action server and client (C++)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Actions/Writing-a-Py-Action-Server-Client.html">Writing an action server and client (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Developing-a-ROS-2-Package.html">Developing a ROS 2 package</a></li>
<li class="toctree-l2"><a class="reference internal" href="Colcon-Tutorial.html">Using colcon to build packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="Ament-CMake-Documentation.html">ament_cmake user documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="Launch-system.html">Launching/monitoring multiple nodes with Launch</a></li>
<li class="toctree-l2"><a class="reference internal" href="Node-arguments.html">Passing ROS arguments to nodes via the command-line</a></li>
<li class="toctree-l2"><a class="reference internal" href="Introspection-with-command-line-tools.html">Introspection with command line tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="RQt-Overview-Usage.html">Overview and usage of RQt</a><ul>
<li class="toctree-l3"><a class="reference internal" href="RQt-Source-Install.html">Building RQt from source</a><ul>
<li class="toctree-l4"><a class="reference internal" href="RQt-Source-Install-MacOS.html">Building RQt from source on macOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="RQt-Source-Install-Windows10.html">Building RQt from source on Windows 10</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Composition.html">Composing multiple nodes in a single process</a></li>
<li class="toctree-l2"><a class="reference internal" href="Ros2bag/Overriding-QoS-Policies-For-Recording-And-Playback.html">Overriding QoS Policies For Recording And Playback</a></li>
<li class="toctree-l2"><a class="reference internal" href="Sync-Vs-Async.html">Synchronous vs. asynchronous service clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="Working-with-multiple-RMW-implementations.html">Working with multiple ROS 2 middleware implementations</a></li>
<li class="toctree-l2"><a class="reference internal" href="catment.html">On the mixing of ament and catkin (catment)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Cross-compilation.html">Cross-compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="Allocator-Template-Tutorial.html">Implement a custom memory allocator</a></li>
<li class="toctree-l2"><a class="reference internal" href="Releasing-a-ROS-2-package-with-bloom.html">Releasing a ROS 2 package with bloom</a></li>
<li class="toctree-l2"><a class="reference internal" href="RQt-Port-Plugin-Windows.html">Porting RQt plugins to Windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="Run-2-nodes-in-a-single-docker-container.html">Running 2 nodes in a single docker container [community-contributed]</a></li>
<li class="toctree-l2"><a class="reference internal" href="Run-2-nodes-in-two-separate-docker-containers.html">Running 2 nodes in 2 separate docker containers [community-contributed]</a></li>
<li class="toctree-l2"><a class="reference internal" href="Deploying-ROS-2-on-IBM-Cloud.html">ROS2 on IBM Cloud Kubernetes [community-contributed]</a></li>
<li class="toctree-l2"><a class="reference internal" href="Launch-files-migration-guide.html">Migrating launch files from ROS 1 to ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="Eclipse-Oxygen-with-ROS-2-and-rviz2.html">Eclipse Oxygen with ROS 2 and rviz2 [community-contributed]</a></li>
<li class="toctree-l2"><a class="reference internal" href="Building-ROS-2-on-Linux-with-Eclipse-Oxygen.html">Building ROS 2 on Linux with Eclipse Oxygen [community-contributed]</a></li>
<li class="toctree-l2"><a class="reference internal" href="Building-Realtime-rt_preempt-kernel-for-ROS-2.html">Building realtime Linux for ROS 2 [community-contributed]</a></li>
<li class="toctree-l2"><a class="reference internal" href="Parameters-YAML-files-migration-guide.html">Migrating YAML parameter files from ROS 1 to ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="Quality-of-Service.html">Use quality-of-service settings to handle lossy networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="Managed-Nodes.html">Management of nodes with managed lifecycles</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Efficient intra-process communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="Rosbag-with-ROS1-Bridge.html">Recording and playback of topic data with rosbag using the ROS 1 bridge</a></li>
<li class="toctree-l2"><a class="reference internal" href="tf2.html">Using tf2 with ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="URDF/Using-URDF-with-Robot-State-Publisher.html">Using URDF with robot_state_publisher</a></li>
<li class="toctree-l2"><a class="reference internal" href="Real-Time-Programming.html">Real-time programming in ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="dummy-robot-demo.html">Trying the dummy robot demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="Logging-and-logger-configuration.html">Logging and logger configuration demo</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Concepts.html">Concepts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/DDS-and-ROS-middleware-implementations.html">About different ROS 2 DDS/RTPS vendors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Quality-of-Service-Settings.html">About Quality of Service settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-ROS-Interfaces.html">About ROS 2 interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/ROS-2-Client-Libraries.html">About ROS 2 client libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/Logging.html">About logging and logger configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-ROS-2-Parameters.html">About parameters in ROS 2</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Troubleshooting/Installation-Troubleshooting.html">Installation troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Troubleshooting/DDS-tuning.html">DDS tuning information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Contributing/ROS-2-On-boarding-Guide.html">ROS 2 on-boarding guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Contributing/Developer-Guide.html">ROS 2 developer guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Contributing/Code-Style-Language-Versions.html">Code style and language versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Contributing/Design-Guide.html">Design guide: common patterns in ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Contributing/Quality-Guide.html">Quality guide: ensuring code quality</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Contributing/Build-Cop-and-Build-Farmer-Guide.html">Build cop and build farmer guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Contributing/CI-Server-Setup.html">How to setup the Jenkins master</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Contributing/Set-up-a-new-Linux-CI-node.html">How to setup Linux Jenkins nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Contributing/Set-up-a-new-macOS-CI-node.html">How to setup a macOS Jenkins node</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Contributing/Set-up-a-new-Windows-CI-node.html">How to setup a Windows Jenkins node</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Contributing/Migration-Guide.html">Migration guide from ROS 1</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Contributing/Migration-Guide-Python.html">Python migration guide from ROS 1</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Contributing/Examples-and-Tools-for-ROS1----ROS2-Migrations.html">Examples and tools for ROS1-to-ROS2 migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Contributing/Inter-Sphinx-Support.html">Using Sphinx for cross-referencing packages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Contact.html">Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ROSCon-Content.html">ROSCon Content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Releases.html">Distributions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Alpha-Overview.html">ROS 2 alpha releases (Aug 2015 - Oct 2016)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Beta1-Overview.html">Beta 1 (codename 'Asphalt'; December 2016)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Beta2-Overview.html">Beta 2 (codename 'r2b2'; July 2017)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Beta3-Overview.html">Beta 3 (codename 'r2b3'; September 2017)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Ardent-Apalone.html">ROS 2 Ardent Apalone (codename 'ardent'; December 2017)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Bouncy-Bolson.html">ROS 2 Bouncy Bolson (codename 'bouncy'; June 2018)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Crystal-Clemmys.html">ROS 2 Crystal Clemmys (codename 'crystal'; December 2018)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Dashing-Diademata.html">ROS 2 Dashing Diademata (codename 'dashing'; May 31st, 2019)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Eloquent-Elusor.html">ROS 2 Eloquent Elusor (codename 'eloquent'; November 22nd, 2019)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Foxy-Fitzroy.html">ROS 2 Foxy Fitzroy (codename 'foxy'; June 5th, 2020)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Galactic-Geochelone.html">ROS 2 Galactic Geochelone (codename 'galactic'; May, 2021)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Howto.html">How to release</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Rolling-Ridley.html">ROS 2 Rolling Ridley (codename 'rolling'; June 2020)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Features.html">Features Status</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Feature-Ideas.html">Feature Ideas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Governance.html">Project Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Marketing.html">Marketing Materials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Related-Projects.html">Related Projects</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Related-Projects/Intel-ROS2-Projects.html">Intel ROS 2 Projects</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ros2 documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../Tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Efficient intra-process communication</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ros2/ros2_documentation/blob/rolling/source/Tutorials/Intra-Process-Communication.rst" class="fa fa-github"> 在 GitHub 上编辑</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             

  
  
  
  <p>
    <strong>
      
      <div class="admonition warning">
        <p class="admonition-title">警告</p>
        <p>
          You're reading the documentation for a version of ROS 2 that has reached its EOL (end-of-life), and is no longer officially supported. If you want up-to-date information, please have a look at <a href="../../../zh-cn/kilted/index.html">Kilted</a>.
        </p>
      </div>
      
    </strong>
  </p>


  <section id="efficient-intra-process-communication">
<h1>Efficient intra-process communication<a class="headerlink" href="#efficient-intra-process-communication" title="Link to this heading"></a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">目录</p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id1">Background</a></p></li>
<li><p><a class="reference internal" href="#build-the-demos" id="id2">Build the demos</a></p></li>
<li><p><a class="reference internal" href="#running-and-understanding-the-demos" id="id3">Running and understanding the demos</a></p></li>
<li><p><a class="reference internal" href="#looking-forward" id="id4">Looking forward</a></p></li>
</ul>
</nav>
<section id="background">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Background</a><a class="headerlink" href="#background" title="Link to this heading"></a></h2>
<p>ROS applications typically consist of a composition of individual &quot;nodes&quot; which perform narrow tasks and are decoupled from other parts of the system.
This promotes fault isolation, faster development, modularity, and code reuse, but it often comes at the cost of performance.
After ROS 1 was initially developed, the need for efficient composition of nodes became obvious and Nodelets were developed.
In ROS 2 we aim to improve on the design of Nodelets by addressing some fundamental problems that required restructuring of nodes.</p>
<p>In this demo we'll be highlighting how nodes can be composed manually, by defining the nodes separately but combining them in different process layouts without changing the node's code or limiting its abilities.</p>
</section>
<section id="build-the-demos">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Build the demos</a><a class="headerlink" href="#build-the-demos" title="Link to this heading"></a></h2>
<p>These demos should work on any of the three major OSs (Windows, Mac, or Linux).
Some of them do require OpenCV to have been installed.</p>
<section id="using-the-pre-built-binaries">
<h3>Using the pre-built binaries<a class="headerlink" href="#using-the-pre-built-binaries" title="Link to this heading"></a></h3>
<p>If you've installed the binaries, simply source the ROS 2 setup file and then skip down to any of the individual demos to see how to run them.</p>
</section>
<section id="building-from-source">
<h3>Building from source<a class="headerlink" href="#building-from-source" title="Link to this heading"></a></h3>
<p>Make sure you have OpenCV installed and then follow the source instructions.
You can find the from source instructions linked from the main <a class="reference internal" href="../Installation.html"><span class="doc">ros2 installation page</span></a>.
Once built source the setup file and continue down to one of the specific demos to read about them and for instructions on how to run them.</p>
</section>
</section>
<section id="running-and-understanding-the-demos">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Running and understanding the demos</a><a class="headerlink" href="#running-and-understanding-the-demos" title="Link to this heading"></a></h2>
<p>There are a few different demos: some are toy problems designed to highlight features of the intra process communications functionality and some are end to end examples which use OpenCV and demonstrate the ability to recombine nodes into different configurations.</p>
<section id="the-two-node-pipeline-demo">
<h3>The two node pipeline demo<a class="headerlink" href="#the-two-node-pipeline-demo" title="Link to this heading"></a></h3>
<p>This demo is designed to show that the intra process publish/subscribe connection can result in zero-copy transport of messages when publishing and subscribing with <code class="docutils literal notranslate"><span class="pre">std::unique_ptr</span></code>s.</p>
<p>First let's take a look at the source:</p>
<p><a class="reference external" href="https://github.com/ros2/demos/blob/eloquent/intra_process_demo/src/two_node_pipeline/two_node_pipeline.cpp">https://github.com/ros2/demos/blob/eloquent/intra_process_demo/src/two_node_pipeline/two_node_pipeline.cpp</a></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cinttypes&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;utility&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rclcpp/rclcpp.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;std_msgs/msg/int32.hpp&quot;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="o">::</span><span class="nn">chrono_literals</span><span class="p">;</span>

<span class="c1">// Node that produces messages.</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Producer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Producer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">output</span><span class="p">)</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">NodeOptions</span><span class="p">().</span><span class="n">use_intra_process_comms</span><span class="p">(</span><span class="nb">true</span><span class="p">))</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Create a publisher on the output topic.</span>
<span class="w">    </span><span class="n">pub_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">remove_pointer</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">pub_</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;</span><span class="w"> </span><span class="n">captured_pub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pub_</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Create a timer which publishes on the output topic at ~1Hz.</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">captured_pub</span><span class="p">]()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">pub_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">captured_pub</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pub_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">::</span><span class="n">UniquePtr</span><span class="w"> </span><span class="nf">msg</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="p">());</span>
<span class="w">        </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span>
<span class="w">          </span><span class="s">&quot;Published message with value: %d, and address: 0x%&quot;</span><span class="w"> </span><span class="n">PRIXPTR</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
<span class="w">          </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
<span class="w">        </span><span class="n">pub_ptr</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="n">timer_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">callback</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">pub_</span><span class="p">;</span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">timer_</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Node that consumes messages.</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Consumer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Consumer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">input</span><span class="p">)</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">NodeOptions</span><span class="p">().</span><span class="n">use_intra_process_comms</span><span class="p">(</span><span class="nb">true</span><span class="p">))</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Create a subscription on the input topic which prints on receipt of new messages.</span>
<span class="w">    </span><span class="n">sub_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">      </span><span class="n">input</span><span class="p">,</span>
<span class="w">      </span><span class="mi">10</span><span class="p">,</span>
<span class="w">      </span><span class="p">[](</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">::</span><span class="n">UniquePtr</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span>
<span class="w">          </span><span class="s">&quot; Received message with value: %d, and address: 0x%&quot;</span><span class="w"> </span><span class="n">PRIXPTR</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
<span class="w">          </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">sub_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">_IONBF</span><span class="p">,</span><span class="w"> </span><span class="n">BUFSIZ</span><span class="p">);</span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">executors</span><span class="o">::</span><span class="n">SingleThreadedExecutor</span><span class="w"> </span><span class="n">executor</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">producer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Producer</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;producer&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;number&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">consumer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Consumer</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;consumer&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;number&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">executor</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">producer</span><span class="p">);</span>
<span class="w">  </span><span class="n">executor</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">consumer</span><span class="p">);</span>
<span class="w">  </span><span class="n">executor</span><span class="p">.</span><span class="n">spin</span><span class="p">();</span>

<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you can see by looking at the <code class="docutils literal notranslate"><span class="pre">main</span></code> function, we have a producer and a consumer node, we add them to a single threaded executor, and then call spin.</p>
<p>If you look at the &quot;producer&quot; node's implementation in the <code class="docutils literal notranslate"><span class="pre">Producer</span></code> struct, you can see that we have created a publisher which publishes on the &quot;number&quot; topic and a timer which periodically creates a new message, prints out its address in memory and its content's value and then publishes it.</p>
<p>The &quot;consumer&quot; node is a bit simpler, you can see its implementation in the <code class="docutils literal notranslate"><span class="pre">Consumer</span></code> struct, as it only subscribes to the &quot;number&quot; topic and prints the address and value of the message it receives.</p>
<p>The expectation is that the producer will print out an address and value and the consumer will print out a matching address and value.
This demonstrates that intra process communication is indeed working and unnecessary copies are avoided, at least for simple graphs.</p>
<p>Let's run the demo by executing <code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">run</span> <span class="pre">intra_process_demo</span> <span class="pre">two_node_pipeline</span></code> executable (don't forget to source the setup file first):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ros2<span class="w"> </span>run<span class="w"> </span>intra_process_demo<span class="w"> </span>two_node_pipeline
Published<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fb02303faf0
Published<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fb020cf0520
<span class="w"> </span>Received<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fb020cf0520
Published<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">2</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fb020e12900
<span class="w"> </span>Received<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">2</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fb020e12900
Published<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">3</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fb020cf0520
<span class="w"> </span>Received<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">3</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fb020cf0520
Published<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">4</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fb020e12900
<span class="w"> </span>Received<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">4</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fb020e12900
Published<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">5</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fb02303cea0
<span class="w"> </span>Received<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">5</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fb02303cea0
<span class="o">[</span>...<span class="o">]</span>
</pre></div>
</div>
<p>One thing you'll notice is that the messages tick along at about one per second.
This is because we told the timer to fire at about once per second.</p>
<p>Also you may have noticed that the first message (with value <code class="docutils literal notranslate"><span class="pre">0</span></code>) does not have a corresponding &quot;Received message ...&quot; line.
This is because publish/subscribe is &quot;best effort&quot; and we do not have any &quot;latching&quot; like behavior enabled.
This means that if the publisher publishes a message before the subscription has been established, the subscription will not receive that message.
This race condition can result in the first few messages being lost.
In this case, since they only come once per second, usually only the first message is lost.</p>
<p>Finally, you can see that &quot;Published message...&quot; and &quot;Received message ...&quot; lines with the same value also have the same address.
This shows that the address of the message being received is the same as the one that was published and that it is not a copy.
This is because we're publishing and subscribing with <code class="docutils literal notranslate"><span class="pre">std::unique_ptr</span></code>s which allow ownership of a message to be moved around the system safely.
You can also publish and subscribe with <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">&amp;</span></code> and <code class="docutils literal notranslate"><span class="pre">std::shared_ptr</span></code>, but zero-copy will not occur in that case.</p>
</section>
<section id="the-cyclic-pipeline-demo">
<h3>The cyclic pipeline demo<a class="headerlink" href="#the-cyclic-pipeline-demo" title="Link to this heading"></a></h3>
<p>This demo is similar to the previous one, but instead of the producer creating a new message for each iteration, this demo only ever uses one message instance.
This is achieved by creating a cycle in the graph and &quot;kicking off&quot; communication by externally making one of the nodes publish before spinning the executor:</p>
<p><a class="reference external" href="https://github.com/ros2/demos/blob/eloquent/intra_process_demo/src/cyclic_pipeline/cyclic_pipeline.cpp">https://github.com/ros2/demos/blob/eloquent/intra_process_demo/src/cyclic_pipeline/cyclic_pipeline.cpp</a></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cinttypes&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;utility&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rclcpp/rclcpp.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;std_msgs/msg/int32.hpp&quot;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="o">::</span><span class="nn">chrono_literals</span><span class="p">;</span>

<span class="c1">// This node receives an Int32, waits 1 second, then increments and sends it.</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">IncrementerPipe</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">IncrementerPipe</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">out</span><span class="p">)</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">NodeOptions</span><span class="p">().</span><span class="n">use_intra_process_comms</span><span class="p">(</span><span class="nb">true</span><span class="p">))</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Create a publisher on the output topic.</span>
<span class="w">    </span><span class="n">pub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">remove_pointer</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">pub</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;</span><span class="w"> </span><span class="n">captured_pub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pub</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Create a subscription on the input topic.</span>
<span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">      </span><span class="n">in</span><span class="p">,</span>
<span class="w">      </span><span class="mi">10</span><span class="p">,</span>
<span class="w">      </span><span class="p">[</span><span class="n">captured_pub</span><span class="p">](</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">::</span><span class="n">UniquePtr</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">pub_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">captured_pub</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pub_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span>
<span class="w">          </span><span class="s">&quot;Received message with value:         %d, and address: 0x%&quot;</span><span class="w"> </span><span class="n">PRIXPTR</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
<span class="w">          </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;  sleeping for 1 second...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span><span class="w">    </span><span class="c1">// Return if the sleep failed (e.g. on ctrl-c).</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;  done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">++</span><span class="p">;</span><span class="w">    </span><span class="c1">// Increment the message&#39;s data.</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span>
<span class="w">          </span><span class="s">&quot;Incrementing and sending with value: %d, and address: 0x%&quot;</span><span class="w"> </span><span class="n">PRIXPTR</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
<span class="w">          </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
<span class="w">        </span><span class="n">pub_ptr</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span><span class="w">    </span><span class="c1">// Send the message along to the output topic.</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">pub</span><span class="p">;</span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">sub</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">_IONBF</span><span class="p">,</span><span class="w"> </span><span class="n">BUFSIZ</span><span class="p">);</span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">executors</span><span class="o">::</span><span class="n">SingleThreadedExecutor</span><span class="w"> </span><span class="n">executor</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Create a simple loop by connecting the in and out topics of two IncrementerPipe&#39;s.</span>
<span class="w">  </span><span class="c1">// The expectation is that the address of the message being passed between them never changes.</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">pipe1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">IncrementerPipe</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;pipe1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;topic1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;topic2&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">pipe2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">IncrementerPipe</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;pipe2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;topic2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;topic1&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">);</span><span class="w">  </span><span class="c1">// Wait for subscriptions to be established to avoid race conditions.</span>
<span class="w">  </span><span class="c1">// Publish the first message (kicking off the cycle).</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">msg</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="p">());</span>
<span class="w">  </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;Published first message with value:  %d, and address: 0x%&quot;</span><span class="w"> </span><span class="n">PRIXPTR</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
<span class="w">    </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
<span class="w">  </span><span class="n">pipe1</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>

<span class="w">  </span><span class="n">executor</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">pipe1</span><span class="p">);</span>
<span class="w">  </span><span class="n">executor</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">pipe2</span><span class="p">);</span>
<span class="w">  </span><span class="n">executor</span><span class="p">.</span><span class="n">spin</span><span class="p">();</span>

<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Unlike the previous demo, this demo uses only one Node, instantiated twice with different names and configurations.
The graph ends up being <code class="docutils literal notranslate"><span class="pre">pipe1</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">pipe2</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">pipe1</span></code> ... in a loop.</p>
<p>The line <code class="docutils literal notranslate"><span class="pre">pipe1-&gt;pub-&gt;publish(msg);</span></code> kicks the process off, but from then on the messages are passed back and forth between the nodes by each one calling publish within its own subscription callback.</p>
<p>The expectation here is that the nodes pass the message back and forth, once a second, incrementing the value of the message each time.
Because the message is being published and subscribed to as a <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> the same message created at the beginning is continuously used.</p>
<p>To test those expectations, let's run it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>%<span class="w"> </span>ros2<span class="w"> </span>run<span class="w"> </span>intra_process_demo<span class="w"> </span>cyclic_pipeline
Published<span class="w"> </span>first<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w">  </span><span class="m">42</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fd2ce0a2bc0
Received<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w">         </span><span class="m">42</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fd2ce0a2bc0
<span class="w">  </span>sleeping<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>second...
<span class="w">  </span><span class="k">done</span>.
Incrementing<span class="w"> </span>and<span class="w"> </span>sending<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">43</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fd2ce0a2bc0
Received<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w">         </span><span class="m">43</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fd2ce0a2bc0
<span class="w">  </span>sleeping<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>second...
<span class="w">  </span><span class="k">done</span>.
Incrementing<span class="w"> </span>and<span class="w"> </span>sending<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">44</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fd2ce0a2bc0
Received<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w">         </span><span class="m">44</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fd2ce0a2bc0
<span class="w">  </span>sleeping<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>second...
<span class="w">  </span><span class="k">done</span>.
Incrementing<span class="w"> </span>and<span class="w"> </span>sending<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">45</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fd2ce0a2bc0
Received<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w">         </span><span class="m">45</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fd2ce0a2bc0
<span class="w">  </span>sleeping<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>second...
<span class="w">  </span><span class="k">done</span>.
Incrementing<span class="w"> </span>and<span class="w"> </span>sending<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">46</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fd2ce0a2bc0
Received<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w">         </span><span class="m">46</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fd2ce0a2bc0
<span class="w">  </span>sleeping<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>second...
<span class="w">  </span><span class="k">done</span>.
Incrementing<span class="w"> </span>and<span class="w"> </span>sending<span class="w"> </span>with<span class="w"> </span>value:<span class="w"> </span><span class="m">47</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fd2ce0a2bc0
Received<span class="w"> </span>message<span class="w"> </span>with<span class="w"> </span>value:<span class="w">         </span><span class="m">47</span>,<span class="w"> </span>and<span class="w"> </span>address:<span class="w"> </span>0x7fd2ce0a2bc0
<span class="w">  </span>sleeping<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>second...
<span class="o">[</span>...<span class="o">]</span>
</pre></div>
</div>
<p>You should see ever increasing numbers on each iteration, starting with 42... because 42, and the whole time it reuses the same message, as demonstrated by the pointer addresses which do not change, which avoids unnecessary copies.</p>
</section>
<section id="the-image-pipeline-demo">
<h3>The image pipeline demo<a class="headerlink" href="#the-image-pipeline-demo" title="Link to this heading"></a></h3>
<p>In this demo we'll use OpenCV to capture, annotate, and then view images.</p>
<p>Note for macOS users: If these examples do not work or you receive an error like <code class="docutils literal notranslate"><span class="pre">ddsi_conn_write</span> <span class="pre">failed</span> <span class="pre">-1</span></code> then you'll need to increase your system wide UDP packet size:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sudo<span class="w"> </span>sysctl<span class="w"> </span>-w<span class="w"> </span>net.inet.udp.recvspace<span class="o">=</span><span class="m">209715</span>
$<span class="w"> </span>sudo<span class="w"> </span>sysctl<span class="w"> </span>-w<span class="w"> </span>net.inet.udp.maxdgram<span class="o">=</span><span class="m">65500</span>
</pre></div>
</div>
<p>These changes will not persist after a reboot.</p>
<section id="simple-pipeline">
<h4>Simple pipeline<a class="headerlink" href="#simple-pipeline" title="Link to this heading"></a></h4>
<p>First we'll have a pipeline of three nodes, arranged as such: <code class="docutils literal notranslate"><span class="pre">camera_node</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">watermark_node</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">image_view_node</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">camera_node</span></code> reads from camera device <code class="docutils literal notranslate"><span class="pre">0</span></code> on your computer, writes some information on the image and publishes it.
The <code class="docutils literal notranslate"><span class="pre">watermark_node</span></code> subscribes to the output of the <code class="docutils literal notranslate"><span class="pre">camera_node</span></code> and adds more text before publishing it too.
Finally, the <code class="docutils literal notranslate"><span class="pre">image_view_node</span></code> subscribes to the output of the <code class="docutils literal notranslate"><span class="pre">watermark_node</span></code>, writes more text to the image and then visualizes it with <code class="docutils literal notranslate"><span class="pre">cv::imshow</span></code>.</p>
<p>In each node the address of the message which is being sent, or which has been received, or both, is written to the image.
The watermark and image view nodes are designed to modify the image without copying it and so the addresses imprinted on the image should all be the same as long as the nodes are in the same process and the graph remains organized in a pipeline as sketched above.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>On some systems (we've seen it happen on Linux), the address printed to the screen might not change.
This is because the same unique pointer is being reused. In this situation, the pipeline is still running.</p>
</div>
<p>Let's run the demo by executing the following executable:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>run<span class="w"> </span>intra_process_demo<span class="w"> </span>image_pipeline_all_in_one
</pre></div>
</div>
<p>You should see something like this:</p>
<a class="reference external image-reference" href="https://i.imgur.com/tqiIVgT.png"><img alt="" src="https://i.imgur.com/tqiIVgT.png" />
</a>
<p>You can pause the rendering of the image by pressing the spacebar and you can resume by pressing the spacebar again.
You can also press <code class="docutils literal notranslate"><span class="pre">q</span></code> or <code class="docutils literal notranslate"><span class="pre">ESC</span></code> to exit.</p>
<p>If you pause the image viewer, you should be able to compare the addresses written on the image and see that they are the same.</p>
</section>
<section id="pipeline-with-two-image-viewers">
<h4>Pipeline with two image viewers<a class="headerlink" href="#pipeline-with-two-image-viewers" title="Link to this heading"></a></h4>
<p>Now let's look at an example just like the one above, except it has two image view nodes.
All the nodes are still in the same process, but now two image view windows should show up. (Note for macOS users: your image view windows might be on top of each other).
Let's run it with the command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>run<span class="w"> </span>intra_process_demo<span class="w"> </span>image_pipeline_with_two_image_view
</pre></div>
</div>
<a class="reference external image-reference" href="https://i.imgur.com/iLIT02t.png"><img alt="" src="https://i.imgur.com/iLIT02t.png" />
</a>
<p>Just like the last example, you can pause the rendering with the spacebar and continue by pressing the spacebar a second time. You can stop the updating to inspect the pointers written to the screen.</p>
<p>As you can see in the example image above, we have one image with all of the pointers the same and then another image with the same pointers as the first image for the first two entries, but the last pointer on the second image is different. To understand why this is happening consider the graph's topology:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>camera_node<span class="w"> </span>-&gt;<span class="w"> </span>watermark_node<span class="w"> </span>-&gt;<span class="w"> </span>image_view_node
<span class="w">                              </span>-&gt;<span class="w"> </span>image_view_node2
</pre></div>
</div>
<p>The link between the <code class="docutils literal notranslate"><span class="pre">camera_node</span></code> and the <code class="docutils literal notranslate"><span class="pre">watermark_node</span></code> can use the same pointer without copying because there is only one intra process subscription to which the message should be delivered. But for the link between the <code class="docutils literal notranslate"><span class="pre">watermark_node</span></code> and the two image view nodes the relationship is one to many, so if the image view nodes were using <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> callbacks then it would be impossible to deliver the ownership of the same pointer to both. It can be, however, delivered to one of them. Which one would get the original pointer is not defined, but instead is simply the last to be delivered.</p>
<p>Note that the image view nodes are not subscribed with <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> callbacks. Instead they are subscribed with <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">shared_ptr</span></code>s. This means the system deliveres the same <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code> to both callbacks. When the first intraprocess subscription is handled, the internally stored <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> is promoted to a <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code>. Each of the callbacks will receive shared ownership of the same message.</p>
</section>
<section id="pipeline-with-interprocess-viewer">
<h4>Pipeline with interprocess viewer<a class="headerlink" href="#pipeline-with-interprocess-viewer" title="Link to this heading"></a></h4>
<p>One other important thing to get right is to avoid interruption of the intra process zero-copy behavior when interprocess subscriptions are made. To test this we can run the first image pipeline demo, <code class="docutils literal notranslate"><span class="pre">image_pipeline_all_in_one</span></code>, and then run an instance of the stand alone <code class="docutils literal notranslate"><span class="pre">image_view_node</span></code> (don't forget to prefix them with <code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">run</span> <span class="pre">intra_process_demo</span></code> in the terminal). This will look something like this:</p>
<a class="reference external image-reference" href="https://i.imgur.com/MoWRH1u.png"><img alt="" src="https://i.imgur.com/MoWRH1u.png" />
</a>
<p>It's hard to pause both images at the same time so the images may not line up, but the important thing to notice is that the <code class="docutils literal notranslate"><span class="pre">image_pipeline_all_in_one</span></code> image view shows the same address for each step. This means that the intra process zero-copy is preserved even when an external view is subscribed as well. You can also see that the interprocess image view has different process IDs for the first two lines of text and the process ID of the standalone image viewer in the third line of text.</p>
</section>
</section>
</section>
<section id="looking-forward">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Looking forward</a><a class="headerlink" href="#looking-forward" title="Link to this heading"></a></h2>
<p>These demos are the foundation for some cool new features on which we're actively working, but right now some things are missing.</p>
<section id="room-for-improvement">
<h3>Room for Improvement<a class="headerlink" href="#room-for-improvement" title="Link to this heading"></a></h3>
<p>Let's start by looking at what we at OSRF know we can do better or differently and move on from there.</p>
<section id="performance-performance-performance">
<h4>Performance, Performance, Performance<a class="headerlink" href="#performance-performance-performance" title="Link to this heading"></a></h4>
<p>This is a very rough first draft. There is a lot of room for improvement, even beyond what has been enumerated above. We'll start to improve performance as we dig into the details of the system, build up a better understanding of exactly what our middleware vendors are doing, and try alternative strategies for implementing intra process.</p>
</section>
<section id="latching">
<h4>Latching<a class="headerlink" href="#latching" title="Link to this heading"></a></h4>
<p>We haven't fully implemented the concept of latching yet, but it's very likely we'll need to adjust the implementation of the intra process manager to account for the fact that late intra process subscriptions should be delivered to as well. There are several options on how to do that, and we'll do some testing and figure out what to do in the near future.</p>
</section>
<section id="beyond-pub-sub">
<h4>Beyond Pub/Sub<a class="headerlink" href="#beyond-pub-sub" title="Link to this heading"></a></h4>
<p>We've not done any of this with Services, Parameters, or Actions, but we will.</p>
</section>
<section id="type-masquerading">
<h4>Type Masquerading<a class="headerlink" href="#type-masquerading" title="Link to this heading"></a></h4>
<p>This is one of the coolest upcoming features that we didn't get to in this demo.
Imagine the image pipeline demo above, but rather than passing <code class="docutils literal notranslate"><span class="pre">sensor_msgs/Image</span></code>s around, you're publishing and subscribing to <code class="docutils literal notranslate"><span class="pre">cv::Mat</span></code> objects. This exists in ROS 1, see: <a class="reference external" href="https://wiki.ros.org/roscpp/Overview/MessagesSerializationAndAdaptingTypes">https://wiki.ros.org/roscpp/Overview/MessagesSerializationAndAdaptingTypes</a></p>
<p>In ROS 1, this is accomplished by serializing/deserializing the third party type when handling it. This means that with intra process you'll be serializing when passing it between nodelets. But in ROS 2 we want to do it in the most performant way possible. Similar to how these demos have been demonstrating that an instance of a message can be used through the whole pipeline in certain cases, we'd like to do the same with third party types. So conceivably you could have the image pipeline with a single <code class="docutils literal notranslate"><span class="pre">cv::Mat</span></code> which never gets copied by the middleware. To do this requires some additional intelligence in the intra process manager, but we've already got a design and some proof of concepts in the works.</p>
<p>Given these features, hopefully there will come a point where you can trust the middleware to handle your data as efficiently as is possible. This will allow you to write performant algorithms without sacrificing modularity or introspection!</p>
</section>
</section>
</section>
</section>



           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="Managed-Nodes.html" class="btn btn-neutral float-left" title="Management of nodes with managed lifecycles" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="Rosbag-with-ROS1-Bridge.html" class="btn btn-neutral float-right" title="Recording and playback of topic data with rosbag using the ROS 1 bridge" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2018, Open Robotics。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EVD5Z6G6NH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-EVD5Z6G6NH', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>