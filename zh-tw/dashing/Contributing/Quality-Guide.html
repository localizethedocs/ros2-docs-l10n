

<!DOCTYPE html>
<html class="writer-html5" lang="zh-TW" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quality guide: ensuring code quality &mdash; ros2 documentation  說明文件</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="canonical" href="https://projects.localizethedocs.org/ros2-docs-l10n/Contributing/Quality-Guide.html" />
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=7da51243"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=cbf116e0"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜尋" href="../search.html" />
    <link rel="next" title="Migration guide from ROS 1" href="Migration-Guide.html" />
    <link rel="prev" title="Code style and language versions" href="Code-Style-Language-Versions.html" />
 
<script type="text/javascript" src="../ltd-provenance.js"></script>
<script type="text/javascript" src="../ltd-current.js"></script>
<script type="text/javascript" src="../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../ltd-flyout.js"></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            ros2 documentation
              <img src="../_static/dashing-small.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Installation.html">安裝</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Ubuntu-Development-Setup.html">Building ROS 2 on Ubuntu Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Ubuntu-Install-Binary.html">Installing ROS 2 on Ubuntu Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Ubuntu-Install-Debians.html">Installing ROS 2 via Debian Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/macOS-Development-Setup.html">Building ROS 2 on macOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/macOS-Install-Binary.html">Installing ROS 2 on macOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Windows-Development-Setup.html">Building ROS 2 on Windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Windows-Install-Binary.html">Installing ROS 2 on Windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Fedora-Development-Setup.html">Building ROS 2 on Fedora Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Latest-Development-Setup.html">Installing the latest ROS 2 development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Maintaining-a-Source-Checkout.html">Maintaining a source checkout of ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/Prerelease-Testing.html">Pre-release Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Installation/DDS-Implementations.html">Installing DDS implementations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Installation/DDS-Implementations/Install-Connext-Security-Plugins.html">Installing Connext security plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Installation/DDS-Implementations/Install-Connext-University-Eval.html">Installing University or Evaluation versions of RTI Connext DDS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Installation/DDS-Implementations/Working-with-Eclipse-CycloneDDS.html">Working with Eclipse Cyclone DDS</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials.html">教學</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Configuring-ROS2-Environment.html">Configuring your ROS 2 environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Turtlesim/Introducing-Turtlesim.html">Introducing turtlesim and rqt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Understanding-ROS2-Nodes.html">Understanding ROS 2 nodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Topics/Understanding-ROS2-Topics.html">Understanding ROS 2 topics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Services/Understanding-ROS2-Services.html">Understanding ROS 2 services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Parameters/Understanding-ROS2-Parameters.html">Understanding ROS 2 parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Understanding-ROS2-Actions.html">Understanding ROS 2 actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Rqt-Console/Using-Rqt-Console.html">Using rqt_console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Launch-Files/Creating-Launch-Files.html">Creating a launch file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Ros2bag/Recording-And-Playing-Back-Data.html">Recording and playing back data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Workspace/Creating-A-Workspace.html">Creating a workspace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Creating-Your-First-ROS2-Package.html">Creating your first ROS 2 package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Writing-A-Simple-Cpp-Publisher-And-Subscriber.html">Writing a simple publisher and subscriber (C++)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Writing-A-Simple-Py-Publisher-And-Subscriber.html">Writing a simple publisher and subscriber (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Writing-A-Simple-Cpp-Service-And-Client.html">Writing a simple service and client (C++)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Writing-A-Simple-Py-Service-And-Client.html">Writing a simple service and client (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Custom-ROS2-Interfaces.html">Creating custom ROS 2 msg and srv files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Single-Package-Define-And-Use-Interface.html">Expanding on ROS 2 interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Using-Parameters-In-A-Class-CPP.html">Using parameters in a class (C++)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Using-Parameters-In-A-Class-Python.html">Using parameters in a class (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Actions/Creating-an-Action.html">Creating an action</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Actions/Writing-a-Cpp-Action-Server-Client.html">Writing an action server and client (C++)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Actions/Writing-a-Py-Action-Server-Client.html">Writing an action server and client (Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Launch-system.html">Launching/monitoring multiple nodes with Launch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Composition.html">Composing multiple nodes in a single process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Colcon-Tutorial.html">Using colcon to build packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Allocator-Template-Tutorial.html">Implement a custom memory allocator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Deploying-ROS-2-on-IBM-Cloud.html">ROS2 on IBM Cloud Kubernetes [community-contributed]</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Eclipse-Oxygen-with-ROS-2-and-rviz2.html">Eclipse Oxygen with ROS 2 and rviz2 [community-contributed]</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Building-ROS-2-on-Linux-with-Eclipse-Oxygen.html">Building ROS 2 on Linux with Eclipse Oxygen [community-contributed]</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Building-Realtime-rt_preempt-kernel-for-ROS-2.html">Building realtime Linux for ROS 2 [community-contributed]</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Quality-of-Service.html">Use quality-of-service settings to handle lossy networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Managed-Nodes.html">Management of nodes with managed lifecycles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Intra-Process-Communication.html">Efficient intra-process communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Rosbag-with-ROS1-Bridge.html">Recording and playback of topic data with rosbag using the ROS 1 bridge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/tf2.html">Using tf2 with ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Real-Time-Programming.html">Real-time programming in ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/dummy-robot-demo.html">Trying the dummy robot demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Tutorials/Logging-and-logger-configuration.html">Logging and logger configuration demo</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Guides.html">Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Installation-Troubleshooting.html">安裝疑難排解</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Developing-a-ROS-2-Package.html">Developing a ROS 2 package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Ament-CMake-Documentation.html">ament_cmake 使用者文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Launch-files-migration-guide.html">Migrating launch files from ROS 1 to ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Parameters-YAML-files-migration-guide.html">Migrating YAML parameter files from ROS 1 to ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Node-arguments.html">Passing ROS arguments to nodes via the command-line</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Sync-Vs-Async.html">Synchronous vs. asynchronous service clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/DDS-tuning.html">DDS tuning information</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Overriding-QoS-Policies-For-Recording-And-Playback.html">rosbag2: Overriding QoS Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Working-with-multiple-RMW-implementations.html">Working with multiple ROS 2 middleware implementations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Cross-compilation.html">交叉編譯</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Releasing-a-ROS-2-package-with-bloom.html">Releasing a ROS 2 package with bloom</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Using-Python-Packages.html">Using Python Packages with ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/RQt-Port-Plugin-Windows.html">Porting RQt plugins to Windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Run-2-nodes-in-single-or-separate-docker-containers.html">Running ROS 2 nodes in Docker [community-contributed]</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Package-maintainer-guide.html">ROS 2 Package Maintainer Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/Building-a-Custom-Debian-Package.html">Building a custom Debian package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Guides/RQt-Source-Install.html">Building RQt from source</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Guides/RQt-Source-Install-MacOS.html">Building RQt from source on macOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Guides/RQt-Source-Install-Windows10.html">Building RQt from source on Windows 10</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Concepts.html">概念</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Domain-ID.html">The ROS_DOMAIN_ID</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Different-Middleware-Vendors.html">About different ROS 2 DDS/RTPS vendors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Logging.html">About logging and logger configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Quality-of-Service-Settings.html">About Quality of Service settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-ROS-2-Client-Libraries.html">About ROS 2 client libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-ROS-Interfaces.html">About ROS 2 interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-ROS-2-Parameters.html">About parameters in ROS 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Command-Line-Tools.html">Introspection with command line tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-RQt.html">Overview and usage of RQt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Composition.html">About Composition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Catment.html">On the mixing of ament and catkin (catment)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Cross-Compilation.html">About Cross-compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Build-System.html">About the build system</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Internal-Interfaces.html">About internal ROS 2 interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Middleware-Implementations.html">About ROS 2 middleware implementations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Concepts/About-Client-Interfaces.html">ROS 2 Client Interfaces (Client Libraries)</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../Contributing.html">Contributing</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Developer-Guide.html">ROS 2 developer guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="Code-Style-Language-Versions.html">Code style and language versions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Quality guide: ensuring code quality</a></li>
<li class="toctree-l2"><a class="reference internal" href="Migration-Guide.html">Migration guide from ROS 1</a><ul>
<li class="toctree-l3"><a class="reference internal" href="Migration-Guide-Python.html">Python migration guide from ROS 1</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Contact.html">聯絡</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ROSCon-Content.html">ROSCon Content</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Releases.html">散布版</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Alpha-Overview.html">ROS 2 alpha releases (Aug 2015 - Oct 2016)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Beta1-Overview.html">Beta 1 (codename 'Asphalt'; December 2016)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Beta2-Overview.html">Beta 2 (codename 'r2b2'; July 2017)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Beta3-Overview.html">Beta 3 (codename 'r2b3'; September 2017)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Ardent-Apalone.html">ROS 2 Ardent Apalone (codename 'ardent'; December 2017)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Bouncy-Bolson.html">ROS 2 Bouncy Bolson (codename 'bouncy'; June 2018)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Crystal-Clemmys.html">ROS 2 Crystal Clemmys (codename 'crystal'; December 2018)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Dashing-Diademata.html">ROS 2 Dashing Diademata (codename 'dashing'; May 31st, 2019)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Eloquent-Elusor.html">ROS 2 Eloquent Elusor (codename 'eloquent'; November 22nd, 2019)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Foxy-Fitzroy.html">ROS 2 Foxy Fitzroy (codename 'foxy'; June 5th, 2020)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Galactic-Geochelone.html">ROS 2 Galactic Geochelone (codename 'galactic'; May, 2021)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Galactic-Geochelone-Complete-Changelog.html">ROS 2 Galactic Geochelone Complete Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Humble-Hawksbill.html">ROS 2 Humble Hawksbill (codename 'humble'; May, 2022)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Releases/Release-Rolling-Ridley.html">ROS 2 Rolling Ridley (codename 'rolling'; June 2020)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Features.html">Features Status</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Feature-Ideas.html">Feature Ideas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Governance.html">Project Governance</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Governance/ROS2-TSC-Charter.html">ROS 2 Technical Steering Committee Charter</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Marketing.html">Marketing Materials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Related-Projects.html">相關專案</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Related-Projects/Intel-ROS2-Projects.html">Intel ROS 2 Projects</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Glossary.html">詞彙表</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ros2 documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../Contributing.html">Contributing</a></li>
      <li class="breadcrumb-item active">Quality guide: ensuring code quality</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ros2/ros2_documentation/blob/rolling/source/Contributing/Quality-Guide.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             

  
  
  
  <p>
    <strong>
      
      <div class="admonition warning">
        <p class="admonition-title">警告</p>
        <p>
          您正在閱讀已達到生命週期結束（end-of-life，EOL）版本的 ROS 2 文件，該版本不再正式受支援。如果您想獲取最新資訊，請參見 <a href="../../../zh-tw/kilted/index.html">Kilted</a>。
        </p>
      </div>
      
    </strong>
  </p>


  <section id="quality-guide-ensuring-code-quality">
<h1>Quality guide: ensuring code quality<a class="headerlink" href="#quality-guide-ensuring-code-quality" title="連結到這個標頭"></a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">目次表</p>
<ul class="simple">
<li><p><a class="reference internal" href="#static-code-analysis-as-part-of-the-ament-package-build" id="id1">Static code analysis as part of the ament package build</a></p></li>
<li><p><a class="reference internal" href="#static-thread-safety-analysis-via-code-annotation" id="id2">Static Thread Safety Analysis via Code Annotation</a></p></li>
<li><p><a class="reference internal" href="#dynamic-analysis-data-races-deadlocks" id="id3">Dynamic analysis (data races &amp; deadlocks)</a></p></li>
</ul>
</nav>
<p>This page gives guidance about how to improve the software quality of ROS 2 packages, focusing on more specific areas than the Quality Practices section of the <a class="reference internal" href="Developer-Guide.html"><span class="doc">Developer Guide</span></a>.</p>
<p>The sections below intend to address ROS 2 core, application and ecosystem packages and the core client libraries, C++ and Python.
The solutions presented are motivated by design and implementation considerations to improve quality attributes like &quot;Reliability&quot;, &quot;Security&quot;, &quot;Maintainability&quot;, &quot;Determinism&quot;, etc. which relate to non-functional requirements.</p>
<section id="static-code-analysis-as-part-of-the-ament-package-build">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Static code analysis as part of the ament package build</a><a class="headerlink" href="#static-code-analysis-as-part-of-the-ament-package-build" title="連結到這個標頭"></a></h2>
<p><strong>Context</strong>:</p>
<ul class="simple">
<li><p>You have developed your C++ production code.</p></li>
<li><p>You have created a ROS 2 package with build support with <code class="docutils literal notranslate"><span class="pre">ament</span></code>.</p></li>
</ul>
<p><strong>Problem</strong>:</p>
<ul class="simple">
<li><p>Library level static code analysis is not run as part of the package build procedure.</p></li>
<li><p>Library level static code analysis needs to be executed manually.</p></li>
<li><p>Risk of forgetting to execute library level static code analysis before building
a new package version.</p></li>
</ul>
<p><strong>Solution</strong>:</p>
<ul class="simple">
<li><p>Use the integration capabilities of <code class="docutils literal notranslate"><span class="pre">ament</span></code> to execute static code analysis as
part of the package build procedure.</p></li>
</ul>
<p><strong>Implementation</strong>:</p>
<ul class="simple">
<li><p>Insert into the packages <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>...
<span class="k">if</span><span class="o">(</span>BUILD_TESTING<span class="o">)</span>
<span class="w">  </span>find_package<span class="o">(</span>ament_lint_auto<span class="w"> </span>REQUIRED<span class="o">)</span>
<span class="w">  </span>ament_lint_auto_find_test_dependencies<span class="o">()</span>
<span class="w">  </span>...
endif<span class="o">()</span>
...
</pre></div>
</div>
<ul class="simple">
<li><p>Insert the <code class="docutils literal notranslate"><span class="pre">ament_lint</span></code> test dependencies into the packages <code class="docutils literal notranslate"><span class="pre">package.xml</span></code> file.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>...
&lt;package<span class="w"> </span><span class="nv">format</span><span class="o">=</span><span class="s2">&quot;2&quot;</span>&gt;
<span class="w">  </span>...
<span class="w">  </span>&lt;test_depend&gt;ament_lint_auto&lt;/test_depend&gt;
<span class="w">  </span>&lt;test_depend&gt;ament_lint_common&lt;/test_depend&gt;
<span class="w">  </span>...
&lt;/package&gt;
</pre></div>
</div>
<p><strong>Examples</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rclcpp</span></code>:</p>
<ul>
<li><p><a class="reference external" href="https://github.com/ros2/rclcpp/blob/master/rclcpp/CMakeLists.txt">rclcpp/rclcpp/CMakeLists.txt</a></p></li>
<li><p><a class="reference external" href="https://github.com/ros2/rclcpp/blob/master/rclcpp/package.xml">rclcpp/rclcpp/package.xml</a></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">rclcpp_lifecycle</span></code>:</p>
<ul>
<li><p><a class="reference external" href="https://github.com/ros2/rclcpp/blob/master/rclcpp_lifecycle/CMakeLists.txt">rclcpp/rclcpp_lifecycle/CMakeLists.txt</a></p></li>
<li><p><a class="reference external" href="https://github.com/ros2/rclcpp/blob/master/rclcpp_lifecycle/package.xml">rclcpp/rclcpp_lifecycle/package.xml</a></p></li>
</ul>
</li>
</ul>
<p><strong>Resulting context</strong>:</p>
<ul class="simple">
<li><p>The static code analysis tools supported by <code class="docutils literal notranslate"><span class="pre">ament</span></code> are run as part of the package build.</p></li>
<li><p>Static code analysis tools not supported by <code class="docutils literal notranslate"><span class="pre">ament</span></code> need to be executed separately.</p></li>
</ul>
</section>
<section id="static-thread-safety-analysis-via-code-annotation">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Static Thread Safety Analysis via Code Annotation</a><a class="headerlink" href="#static-thread-safety-analysis-via-code-annotation" title="連結到這個標頭"></a></h2>
<p><strong>Context:</strong></p>
<ul class="simple">
<li><p>You are developing/debugging your multithreaded C++ production code</p></li>
<li><p>You access data from multiple threads in C++ code</p></li>
</ul>
<p><strong>Problem:</strong></p>
<ul class="simple">
<li><p>Data races and deadlocks can lead to critical bugs.</p></li>
</ul>
<p><strong>Solution:</strong></p>
<ul class="simple">
<li><p>Utilize Clang's static <a class="reference external" href="https://clang.llvm.org/docs/ThreadSafetyAnalysis.html">Thread Safety Analysis</a> by annotating threaded code</p></li>
</ul>
<p><strong>Context For Implementation:</strong></p>
<p>To enable Thread Safety Analysis, code must be annotated to let the compiler know more about the semantics of the code. These annotations are Clang-specific attributes - e.g. <code class="docutils literal notranslate"><span class="pre">__attribute__(capability()))</span></code>. Instead of using those attributes directly, ROS 2 provides preprocessor macros that are erased when using other compilers.</p>
<p>These macros can be found in <a class="reference external" href="https://github.com/ros2/rcpputils/blob/master/include/rcpputils/thread_safety_annotations.h">rcpputils/thread_safety_annotations.h</a></p>
<dl class="simple">
<dt>The Thread Safety Analysis documentation states</dt><dd><p>Thread safety analysis can be used with any threading library, but it does require that the threading API be wrapped in classes and methods which have the appropriate annotations</p>
</dd>
</dl>
<p>We have decided that we want ROS 2 developers to be able to use <code class="docutils literal notranslate"><span class="pre">std::</span></code> threading primitives directly for their development. We do not want to provide our own wrapped types as is suggested above.</p>
<p>There are three C++ standard libraries to be aware of
* The GNU standard library <code class="docutils literal notranslate"><span class="pre">libstdc++</span></code> - default on Linux, explicitly via the compiler option <code class="docutils literal notranslate"><span class="pre">-stdlib=libstdc++</span></code>
* The LLVM standard library <code class="docutils literal notranslate"><span class="pre">libc++</span></code> (also called <code class="docutils literal notranslate"><span class="pre">libcxx</span></code> ) - default on macOS,  explicitly set by the compiler option <code class="docutils literal notranslate"><span class="pre">-stdlib=libc++</span></code>
* The Windows C++ Standard Library - not relevant to this use case</p>
<p><code class="docutils literal notranslate"><span class="pre">libcxx</span></code> annotates its <code class="docutils literal notranslate"><span class="pre">std::mutex</span></code> and <code class="docutils literal notranslate"><span class="pre">std::lock_guard</span></code> implementations for Thread Safety Analysis. When using GNU <code class="docutils literal notranslate"><span class="pre">libstdc++</span></code> , those annotations are not present, so Thread Safety Analysis cannot be used on non-wrapped <code class="docutils literal notranslate"><span class="pre">std::</span></code> types.</p>
<p><em>Therefore, to use Thread Safety Analysis directly with</em> <code class="docutils literal notranslate"><span class="pre">std::</span></code> <em>types, we must use</em> <code class="docutils literal notranslate"><span class="pre">libcxx</span></code></p>
<p><strong>Implementation:</strong></p>
<p>The code migration suggestions here are by no means complete - when writing (or annotating existing) threaded code, you are encouraged to utilize as many of the annotations as is logical for your use case. However, this step-by-step is a great place to start!</p>
<ul>
<li><p>Enabling Analysis for Package/Target</p>
<p>When the C++ compiler is Clang, enable the <code class="docutils literal notranslate"><span class="pre">-Wthread-safety</span></code> flag. Example below for CMake-based projects</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">if</span><span class="p">(</span><span class="s">CMAKE_CXX_COMPILER_ID</span><span class="w"> </span><span class="s">MATCHES</span><span class="w"> </span><span class="s2">&quot;Clang&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-Wthread-safety</span><span class="p">)</span><span class="w">   </span><span class="c"># for your whole package</span>
<span class="w">  </span><span class="nb">target_compile_options</span><span class="p">(</span><span class="o">${</span><span class="nv">MY_TARGET</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="s">-Wthread-safety</span><span class="p">)</span><span class="w">  </span><span class="c"># for a single library or executable</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Annotating Code</p>
<ul>
<li><p>Step 1 - Annotate data members</p>
<ul class="simple">
<li><p>Find anywhere that <code class="docutils literal notranslate"><span class="pre">std::mutex</span></code> is used to protect some member data</p></li>
<li><p>Add the <code class="docutils literal notranslate"><span class="pre">RCPPUTILS_TSA_GUARDED_BY(mutex_name)</span></code> annotation to the data that is protected by the mutex</p></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Foo</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">incr</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
<span class="w">    </span><span class="n">bar</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bar</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="k">mutable</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">mutex_</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="nf">RCPPUTILS_TSA_GUARDED_BY</span><span class="p">(</span><span class="n">mutex_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</li>
<li><p>Step 2 - Fix Warnings</p>
<ul class="simple">
<li><p>In the above example - <code class="docutils literal notranslate"><span class="pre">Foo::get</span></code> will produce a compiler warning! To fix it, lock before returning bar</p></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">get</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">bar</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Step 3 - (Optional but Recommended) Refactor Existing Code to Private-Mutex Pattern</p>
<p>A recommended pattern in threaded C++ code is to always keep your <code class="docutils literal notranslate"><span class="pre">mutex</span></code> as a <code class="docutils literal notranslate"><span class="pre">private:</span></code> member of the data structure. This makes data safety the concern of the containing structure, offloading that responsibility from users of the structure and minimizing the surface area of affected code.</p>
<p>Making your locks private may require rethinking the interfaces to your data. This is a great exercise - here are a few things to consider</p>
<ul class="simple">
<li><p>You may want to provide specialized interfaces for performing analysis that requires complex locking logic, e.g. counting members in a filtered set of a mutex-guarded map structure, instead of actually returning the underlying structure to consumers</p></li>
<li><p>Consider copying to avoid blocking, where the amount of data is small. This can let other threads get on with accessing the shared data, which can potentially lead to better overall performance.</p></li>
</ul>
</li>
<li><p>Step 4 - (Optional) Enable Negative Capability Analysis</p>
<p><a class="reference external" href="https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#negative-capabilities">https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#negative-capabilities</a></p>
<p>Negative Capability Analysis lets you specify “this lock must not be held when calling this function”. It can reveal potential deadlock cases that other annotations cannot.</p>
<ul class="simple">
<li><p>Where you specified <code class="docutils literal notranslate"><span class="pre">-Wthread-safety</span></code>, add the additional flag <code class="docutils literal notranslate"><span class="pre">-Wthread-safety-negative</span></code></p></li>
<li><p>On any function that acquires a lock, use the <code class="docutils literal notranslate"><span class="pre">RCPPUTILS_TSA_REQUIRES(!mutex)</span></code> pattern</p></li>
</ul>
</li>
</ul>
</li>
<li><p>How to run the analysis</p>
<ul class="simple">
<li><p>The ROS CI build farm runs a nightly job with <code class="docutils literal notranslate"><span class="pre">libcxx</span></code>, which will surface any issues in the ROS 2 core stack by being marked &quot;Unstable&quot; when Thread Safety Analysis raises warnings</p></li>
<li><p>For local runs, you have the following options, all equivalent</p>
<ul>
<li><p>Use the colcon <a class="reference external" href="https://github.com/colcon/colcon-mixin-repository/blob/master/clang-libcxx.mixin">clang-libcxx mixin</a></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">colcon</span> <span class="pre">build</span> <span class="pre">--mixin</span> <span class="pre">clang-libcxx</span></code></p></li>
<li><p>You may only use this if you have <a class="reference external" href="https://github.com/colcon/colcon-mixin-repository/blob/master/README.md">configured mixins for your colcon installation</a></p></li>
</ul>
</li>
<li><p>Passing compiler to CMake</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">colcon</span> <span class="pre">build</span> <span class="pre">--cmake-args</span> <span class="pre">-DCMAKE_C_COMPILER=clang</span> <span class="pre">-DCMAKE_CXX_COMPILER=clang++</span> <span class="pre">-DCMAKE_CXX_FLAGS='-stdlib=libc++</span> <span class="pre">-D_LIBCPP_ENABLE_THREAD_SAFETY_ANNOTATIONS'</span> <span class="pre">-DFORCE_BUILD_VENDOR_PKG=ON</span> <span class="pre">--no-warn-unused-cli</span></code></p></li>
</ul>
</li>
<li><p>Overriding system compiler</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">CC=clang</span> <span class="pre">CXX=clang++</span> <span class="pre">colcon</span> <span class="pre">build</span> <span class="pre">--cmake-args</span> <span class="pre">-DCMAKE_CXX_FLAGS='-stdlib=libc++</span> <span class="pre">-D_LIBCPP_ENABLE_THREAD_SAFETY_ANNOTATIONS'</span> <span class="pre">-DFORCE_BUILD_VENDOR_PKG=ON</span> <span class="pre">--no-warn-unused-cli</span></code></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>Resulting Context:</strong></p>
<ul class="simple">
<li><p>Potential deadlocks and race conditions will be surfaced at compile time, when using Clang and <code class="docutils literal notranslate"><span class="pre">libcxx</span></code></p></li>
</ul>
</section>
<section id="dynamic-analysis-data-races-deadlocks">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Dynamic analysis (data races &amp; deadlocks)</a><a class="headerlink" href="#dynamic-analysis-data-races-deadlocks" title="連結到這個標頭"></a></h2>
<p><strong>Context:</strong></p>
<ul class="simple">
<li><p>You are developing/debugging your multithreaded C++ production code.</p></li>
<li><p>You use pthreads or C++11 threading + llvm libc++ (in case of ThreadSanitizer).</p></li>
<li><p>You do not use Libc/libstdc++ static linking (in case of ThreadSanitizer).</p></li>
<li><p>You do not build non-position-independent executables (in case of ThreadSanitizer).</p></li>
</ul>
<p><strong>Problem:</strong></p>
<ul class="simple">
<li><p>Data races and deadlocks can lead to critical bugs.</p></li>
<li><p>Data races and deadlocks cannot be detected using static analysis (reason: limitation of static analysis).</p></li>
<li><p>Data races and deadlocks must not show up during development debugging / testing (reason: usually not all possible control paths through production code exercised).</p></li>
</ul>
<p><strong>Solution:</strong></p>
<ul class="simple">
<li><p>Use a dynamic analysis tool which focuses on finding data races and deadlocks (here clang ThreadSanitizer).</p></li>
</ul>
<p><strong>Implementation:</strong></p>
<ul class="simple">
<li><p>Compile and link the production code with clang using the option <code class="docutils literal notranslate"><span class="pre">-fsanitize=thread</span></code> (this instruments the production code).</p></li>
<li><p>In case different production code shall be executed during analysis consider conditional compilation e.g. <a class="reference external" href="https://clang.llvm.org/docs/ThreadSanitizer.html#has-feature-thread-sanitizer">ThreadSanitizers _has_feature(thread_sanitizer)</a>.</p></li>
<li><p>In case some code shall not be instrumented consider <a class="reference external" href="https://clang.llvm.org/docs/ThreadSanitizer.html#attribute-no-sanitize-thread">ThreadSanitizers _/*attribute*/_((no_sanitize(&quot;thread&quot;)))</a>.</p></li>
<li><p>In case some files shall not be instrumented consider file or function-level exclusion <a class="reference external" href="https://clang.llvm.org/docs/ThreadSanitizer.html#blacklist">ThreadSanitizers blacklisting</a>, more specific: <a class="reference external" href="https://clang.llvm.org/docs/SanitizerSpecialCaseList.html">ThreadSanitizers Sanitizer Special Case List</a> or with <a class="reference external" href="https://clang.llvm.org/docs/ThreadSanitizer.html#blacklist">ThreadSanitizers no_sanitize(&quot;thread&quot;)</a> and use the option <code class="docutils literal notranslate"><span class="pre">--fsanitize-blacklist</span></code>.</p></li>
</ul>
<p><strong>Resulting context:</strong></p>
<ul class="simple">
<li><p>Higher chance to find data races and deadlocks in production code before deploying it.</p></li>
<li><p>Analysis result may lack reliability, tool in beta phase stage (in case of ThreadSanitizer).</p></li>
<li><p>Overhead due to production code instrumentation (maintenance of separate branches for instrumented/not instrumented production code, etc.).</p></li>
<li><p>Instrumented code needs more memory per thread (in case of ThreadSanitizer).</p></li>
<li><p>Instrumented code maps a lot virtual address space (in case of ThreadSanitizer).</p></li>
</ul>
</section>
</section>



           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Code-Style-Language-Versions.html" class="btn btn-neutral float-left" title="Code style and language versions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Migration-Guide.html" class="btn btn-neutral float-right" title="Migration guide from ROS 1" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Open Robotics.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EVD5Z6G6NH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-EVD5Z6G6NH', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>